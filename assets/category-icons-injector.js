/**
 * Generated by Copilot
 * SAAutomotive Category Icons Injector
 * Injects category icons into Zoho Commerce category grid/cards
 * 
 * Usage: Add to Zoho Commerce Site Settings > Header Code
 */

(function() {
  'use strict';

  // Icon base URL (jsDelivr CDN for better performance)
  const ICON_BASE_URL = 'https://cdn.jsdelivr.net/gh/Stan2891/bmparts-ai@main/assets/category-icons';

  // Category name to icon filename mapping
  const CATEGORY_ICON_MAP = {
    'lighting': 'lighting.png',
    'electrical-system': 'electrical-system.png',
    'electrical': 'electrical-system.png',
    'suspension': 'suspension.png',
    'bodywork': 'bodywork.png',
    'body-parts': 'bodywork.png',
    'engine': 'engine.png',
    'engine-parts': 'engine.png',
    'engine-parts-components': 'engine.png',
    'airbags': 'airbags.png',
    'cooling-system': 'cooling-system.png',
    'cooling': 'cooling-system.png',
    'pdc-distance-cruise-control': 'pdc-distance-cruise-control.png',
    'pdc': 'pdc-distance-cruise-control.png',
    'cruise-control': 'pdc-distance-cruise-control.png',
    'trim': 'trim.png',
    'interior': 'trim.png',
    'steering-system': 'steering-system.png',
    'steering': 'steering-system.png',
    'oil-lubricants': 'oil-lubricants.png',
    'oil': 'oil-lubricants.png',
    'lubricants': 'oil-lubricants.png',
    'drivetrain-transmission': 'drivetrain-transmission.png',
    'drivetrain': 'drivetrain-transmission.png',
    'transmission': 'drivetrain-transmission.png'
  };

  /**
   * Normalize category name to match icon filename
   * - Lowercase
   * - Replace spaces, slashes, ampersands with dashes
   * - Remove multiple dashes
   * - Trim dashes from ends
   * @param {string} str - Category name
   * @returns {string} - Normalized key
   */
  function normalizeCategoryName(str) {
    if (!str) return '';
    return str
      .toLowerCase()
      .trim()
      .replace(/[\/\\&]+/g, '-')      // Replace slashes and ampersands with dash
      .replace(/\s+/g, '-')           // Replace spaces with dash
      .replace(/[^a-z0-9-]/g, '')     // Remove non-alphanumeric except dash
      .replace(/-+/g, '-')            // Collapse multiple dashes
      .replace(/^-|-$/g, '');         // Trim dashes from ends
  }

  /**
   * Get icon URL for a category name
   * @param {string} categoryName - Display name of category
   * @returns {string|null} - Icon URL or null if no match
   */
  function getIconUrl(categoryName) {
    const normalized = normalizeCategoryName(categoryName);
    const iconFile = CATEGORY_ICON_MAP[normalized];
    if (iconFile) {
      return `${ICON_BASE_URL}/${iconFile}`;
    }
    return null;
  }

  /**
   * Inject icons into category cards
   */
  function injectCategoryIcons() {
    // Zoho Commerce category card selectors (adjust based on actual theme)
    const selectors = [
      '.category-card',
      '.category-item',
      '.category-grid-item',
      '[class*="category"] a',
      '.collection-card',
      '.menu-category',
      '.zs-category-item',
      '.zs-category-card'
    ];

    const categoryElements = document.querySelectorAll(selectors.join(', '));
    
    categoryElements.forEach(el => {
      // Skip if already processed
      if (el.dataset.iconInjected) return;
      
      // Find category name (from text content or title/alt attribute)
      const categoryName = el.textContent?.trim() || 
                          el.getAttribute('title') || 
                          el.querySelector('[class*="name"], [class*="title"]')?.textContent?.trim();
      
      if (!categoryName) return;
      
      const iconUrl = getIconUrl(categoryName);
      if (!iconUrl) return;
      
      // Create icon container
      const iconContainer = document.createElement('div');
      iconContainer.className = 'saa-category-icon-container';
      
      // Create icon image
      const iconImg = document.createElement('img');
      iconImg.src = iconUrl;
      iconImg.alt = `${categoryName} icon`;
      iconImg.className = 'saa-category-icon';
      iconImg.loading = 'lazy';
      iconImg.onerror = function() {
        this.style.display = 'none';
      };
      
      iconContainer.appendChild(iconImg);
      
      // Insert icon before content
      el.insertBefore(iconContainer, el.firstChild);
      el.dataset.iconInjected = 'true';
      el.classList.add('saa-has-icon');
    });
  }

  /**
   * Inject CSS styles
   */
  function injectStyles() {
    if (document.getElementById('saa-category-icons-css')) return;
    
    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    
    const css = `
      /* SAAutomotive Category Icons - Generated by Copilot */
      
      .saa-category-icon-container {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 56px;
        height: 56px;
        flex-shrink: 0;
        margin-bottom: 10px;
      }
      
      .saa-category-icon {
        height: 45px;
        width: auto;
        object-fit: contain;
        transition: ${prefersReducedMotion ? 'none' : 'transform 0.2s ease, filter 0.2s ease'};
      }
      
      .saa-has-icon {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
      }
      
      /* Hover effect - icon only */
      .saa-has-icon:hover .saa-category-icon,
      .saa-has-icon:focus-within .saa-category-icon {
        ${prefersReducedMotion ? '' : 'transform: translateY(-1px);'}
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.15));
      }
      
      /* Category label styling */
      .saa-has-icon [class*="name"],
      .saa-has-icon [class*="title"],
      .saa-has-icon span:not(.saa-category-icon-container *) {
        font-size: 14px;
        font-weight: 600;
        line-height: 1.2;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%;
      }
      
      /* Tablet (<=768px) */
      @media (max-width: 768px) {
        .saa-category-icon-container {
          width: 52px;
          height: 52px;
        }
        .saa-category-icon {
          height: 42px;
        }
      }
      
      /* Mobile (<=480px) */
      @media (max-width: 480px) {
        .saa-category-icon-container {
          width: 48px;
          height: 48px;
          margin-bottom: 8px;
        }
        .saa-category-icon {
          height: 38px;
        }
        .saa-has-icon [class*="name"],
        .saa-has-icon [class*="title"] {
          font-size: 13px;
        }
      }
    `;
    
    const style = document.createElement('style');
    style.id = 'saa-category-icons-css';
    style.textContent = css;
    document.head.appendChild(style);
  }

  /**
   * Initialize
   */
  function init() {
    injectStyles();
    injectCategoryIcons();
    
    // Re-run on dynamic content changes (SPA navigation)
    const observer = new MutationObserver((mutations) => {
      let shouldRun = false;
      mutations.forEach(m => {
        if (m.addedNodes.length > 0) shouldRun = true;
      });
      if (shouldRun) {
        setTimeout(injectCategoryIcons, 100);
      }
    });
    
    observer.observe(document.body, { 
      childList: true, 
      subtree: true 
    });
  }

  // Run on DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
