/**
 * Generated by Copilot
 * SAAutomotive Homepage Category Replacer
 * Replaces demo "Explore our range" section with real BMW parts categories
 * 
 * Add to: Zoho Commerce > Settings > Site Settings > Third Party Header Code
 */

(function() {
  'use strict';

  // CDN base URL for icons
  const ICON_BASE = 'https://cdn.jsdelivr.net/gh/Stan2891/bmparts-ai@main/assets/category-icons';

  // Part categories with icons and links
  const CATEGORIES = [
    { name: 'Lighting', icon: 'lighting.png', url: '/category/lighting' },
    { name: 'Electrical System', icon: 'electrical-system.png', url: '/category/electrical' },
    { name: 'Suspension', icon: 'suspension.png', url: '/category/suspension' },
    { name: 'Bodywork', icon: 'bodywork.png', url: '/category/body-exterior' },
    { name: 'Engine', icon: 'engine.png', url: '/category/engine' },
    { name: 'Airbags', icon: 'airbags.png', url: '/category/airbags' },
    { name: 'Cooling System', icon: 'cooling-system.png', url: '/category/cooling-system' },
    { name: 'PDC & Cruise Control', icon: 'pdc-distance-cruise-control.png', url: '/category/pdc' },
    { name: 'Trim & Interior', icon: 'trim.png', url: '/category/interior' },
    { name: 'Steering', icon: 'steering-system.png', url: '/category/steering' },
    { name: 'Oil & Lubricants', icon: 'oil-lubricants.png', url: '/category/fluids' },
    { name: 'Drivetrain', icon: 'drivetrain-transmission.png', url: '/category/drivetrain' }
  ];

  /**
   * Inject CSS styles
   */
  function injectStyles() {
    if (document.getElementById('saa-category-grid-css')) return;

    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    
    const css = `
      /* SAAutomotive Category Grid - Generated by Copilot */
      
      /* Hide demo category section */
      .demo-categories,
      [class*="explore-range"] .category-list,
      .zs-category-showcase .category-item-demo {
        display: none !important;
      }

      /* Category Grid Container */
      .saa-category-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 24px;
        padding: 20px 0;
        max-width: 1200px;
        margin: 0 auto;
      }

      /* Category Card */
      .saa-category-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-decoration: none;
        color: inherit;
        padding: 16px;
        border-radius: 12px;
        transition: ${prefersReducedMotion ? 'none' : 'transform 0.2s ease, box-shadow 0.2s ease'};
      }

      .saa-category-card:hover {
        ${prefersReducedMotion ? '' : 'transform: translateY(-2px);'}
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      /* Icon Container */
      .saa-cat-icon-wrap {
        width: 80px;
        height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 50%;
        margin-bottom: 12px;
        transition: ${prefersReducedMotion ? 'none' : 'transform 0.2s ease, box-shadow 0.2s ease'};
      }

      .saa-category-card:hover .saa-cat-icon-wrap {
        ${prefersReducedMotion ? '' : 'transform: translateY(-2px);'}
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.12);
      }

      /* Icon Image */
      .saa-cat-icon {
        height: 45px;
        width: auto;
        object-fit: contain;
      }

      /* Category Name */
      .saa-cat-name {
        font-size: 14px;
        font-weight: 600;
        text-align: center;
        color: #333;
        line-height: 1.3;
        max-width: 120px;
      }

      /* Section Header */
      .saa-section-header {
        text-align: center;
        margin-bottom: 32px;
      }

      .saa-section-header h2 {
        font-size: 28px;
        font-weight: 700;
        color: #1a1a1a;
        margin: 0 0 8px 0;
      }

      .saa-section-header p {
        font-size: 16px;
        color: #666;
        margin: 0;
      }

      /* Tablet */
      @media (max-width: 768px) {
        .saa-category-grid {
          grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
          gap: 16px;
        }
        .saa-cat-icon-wrap {
          width: 70px;
          height: 70px;
        }
        .saa-cat-icon {
          height: 38px;
        }
        .saa-cat-name {
          font-size: 13px;
        }
      }

      /* Mobile */
      @media (max-width: 480px) {
        .saa-category-grid {
          grid-template-columns: repeat(3, 1fr);
          gap: 12px;
        }
        .saa-cat-icon-wrap {
          width: 60px;
          height: 60px;
        }
        .saa-cat-icon {
          height: 32px;
        }
        .saa-cat-name {
          font-size: 12px;
        }
        .saa-category-card {
          padding: 12px 8px;
        }
      }
    `;

    const style = document.createElement('style');
    style.id = 'saa-category-grid-css';
    style.textContent = css;
    document.head.appendChild(style);
  }

  /**
   * Build category grid HTML
   */
  function buildCategoryGrid() {
    const container = document.createElement('div');
    container.className = 'saa-category-section';
    
    // Header
    const header = document.createElement('div');
    header.className = 'saa-section-header';
    header.innerHTML = `
      <h2>Shop by Part Category</h2>
      <p>Quality BMW parts for all models</p>
    `;
    container.appendChild(header);

    // Grid
    const grid = document.createElement('div');
    grid.className = 'saa-category-grid';

    CATEGORIES.forEach(cat => {
      const card = document.createElement('a');
      card.href = cat.url;
      card.className = 'saa-category-card';
      card.innerHTML = `
        <div class="saa-cat-icon-wrap">
          <img src="${ICON_BASE}/${cat.icon}" alt="${cat.name}" class="saa-cat-icon" loading="lazy">
        </div>
        <span class="saa-cat-name">${cat.name}</span>
      `;
      grid.appendChild(card);
    });

    container.appendChild(grid);
    return container;
  }

  /**
   * Replace demo section with real categories
   */
  function replaceDemoSection() {
    // Find the demo section - look for "Explore our range" text
    const sections = document.querySelectorAll('section, div[class*="category"], div[class*="range"]');
    let targetSection = null;

    // Method 1: Find by heading text
    const headings = document.querySelectorAll('h2, h3, [class*="heading"]');
    headings.forEach(h => {
      if (h.textContent && h.textContent.toLowerCase().includes('explore our range')) {
        targetSection = h.closest('section') || h.closest('[class*="category"]') || h.parentElement?.parentElement;
      }
    });

    // Method 2: Find demo category items
    if (!targetSection) {
      const demoItems = document.querySelectorAll('[class*="category-item"], [class*="category-card"]');
      demoItems.forEach(item => {
        const text = item.textContent?.toLowerCase() || '';
        if (text.includes('bluetooth') || text.includes('gaming') || text.includes('cameras')) {
          targetSection = item.closest('section') || item.closest('[class*="category"]');
        }
      });
    }

    if (targetSection && !targetSection.dataset.saaReplaced) {
      // Build new grid
      const newGrid = buildCategoryGrid();
      
      // Replace content
      const existingContent = targetSection.querySelector('[class*="category-list"], [class*="category-grid"], [class*="items"]');
      if (existingContent) {
        existingContent.replaceWith(newGrid);
      } else {
        // Replace entire section content
        targetSection.innerHTML = '';
        targetSection.appendChild(newGrid);
      }
      
      targetSection.dataset.saaReplaced = 'true';
      console.log('[SAA] Category section replaced successfully');
    } else if (!targetSection) {
      // Fallback: Insert after first section or hero
      const hero = document.querySelector('[class*="hero"], [class*="banner"], header + section');
      if (hero) {
        const newGrid = buildCategoryGrid();
        const wrapper = document.createElement('section');
        wrapper.className = 'saa-category-wrapper';
        wrapper.style.cssText = 'padding: 40px 20px; background: #fff;';
        wrapper.appendChild(newGrid);
        hero.parentNode.insertBefore(wrapper, hero.nextSibling);
        console.log('[SAA] Category grid inserted after hero');
      }
    }
  }

  /**
   * Initialize
   */
  function init() {
    injectStyles();
    
    // Wait for DOM to be fully loaded
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        setTimeout(replaceDemoSection, 500);
      });
    } else {
      setTimeout(replaceDemoSection, 500);
    }

    // Re-run on navigation (SPA)
    const observer = new MutationObserver((mutations) => {
      let shouldRun = false;
      mutations.forEach(m => {
        if (m.addedNodes.length > 0) {
          m.addedNodes.forEach(node => {
            if (node.nodeType === 1 && (
              node.matches?.('[class*="category"]') || 
              node.querySelector?.('[class*="category"]')
            )) {
              shouldRun = true;
            }
          });
        }
      });
      if (shouldRun) {
        setTimeout(replaceDemoSection, 300);
      }
    });

    observer.observe(document.body, { childList: true, subtree: true });
  }

  init();
})();
